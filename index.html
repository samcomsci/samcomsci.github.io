<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>SAM & POR ‚Äî Finance</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
<style>
:root {
  --bg:      #080810;
  --bg2:     #0f0f1a;
  --bg3:     #17172a;
  --bg4:     #1f1f35;
  --border:  #26263d;
  --border2: #32324f;
  --text:    #eeeef8;
  --muted:   #64647e;
  --muted2:  #8888a8;
  --sam:     #7c6cfc;
  --sam2:    rgba(124,108,252,.12);
  --por:     #fc6ca0;
  --por2:    rgba(252,108,160,.12);
  --green:   #3dfcb4;
  --green2:  rgba(61,252,180,.12);
  --red:     #fc5c7a;
  --red2:    rgba(252,92,122,.12);
  --yellow:  #fcd03d;
  --yellow2: rgba(252,208,61,.12);
  --accent:  #7c6cfc;
  --r:  14px;
  --r2: 10px;
  --r3: 8px;
}
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { font-size: 16px; -webkit-tap-highlight-color: transparent; }
body {
  font-family: 'DM Sans', sans-serif;
  background: var(--bg); color: var(--text);
  min-height: 100vh; overflow-x: hidden;
  -webkit-font-smoothing: antialiased;
}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.app { display: flex; min-height: 100vh; }

/* SIDEBAR */
.sidebar {
  width: 230px; min-height: 100vh;
  background: var(--bg2);
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column;
  position: fixed; inset: 0 auto 0 0; z-index: 200;
  transition: transform .28s cubic-bezier(.4,0,.2,1);
  overflow-y: auto;
}
.sidebar-brand {
  padding: 22px 20px 18px;
  border-bottom: 1px solid var(--border);
}
.brand-name {
  font-family: 'Space Mono', monospace; font-weight: 700; font-size: 1rem;
  background: linear-gradient(120deg, var(--sam), var(--por));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
}
.brand-sub { font-size: .7rem; color: var(--muted); margin-top: 3px; letter-spacing: .06em; }

.nav-group { padding: 10px 10px 0; }
.nav-group-label {
  font-size: .62rem; text-transform: uppercase; letter-spacing: .14em;
  color: var(--muted); padding: 0 10px; margin-bottom: 6px; display: block;
}
.nav-link {
  display: flex; align-items: center; gap: 10px;
  padding: 9px 10px; border-radius: var(--r3); cursor: pointer;
  font-size: .86rem; color: var(--muted2); margin-bottom: 2px;
  transition: all .18s; white-space: nowrap; user-select: none;
}
.nav-link:hover { background: var(--bg3); color: var(--text); }
.nav-link.active { background: var(--sam2); color: var(--sam); font-weight: 600; }
.nav-icon { font-size: 1.05rem; width: 22px; text-align: center; flex-shrink: 0; }
.nav-badge {
  margin-left: auto; background: var(--red); color: #fff;
  font-size: .6rem; font-weight: 700; padding: 1px 6px; border-radius: 99px;
}

.sidebar-footer {
  margin-top: auto; padding: 16px 10px;
  border-top: 1px solid var(--border);
}
.user-label { font-size: .62rem; text-transform: uppercase; letter-spacing: .12em; color: var(--muted); padding: 0 10px; margin-bottom: 8px; }
.user-item {
  display: flex; align-items: center; gap: 10px;
  padding: 8px 10px; border-radius: var(--r3); cursor: pointer;
  border: none; background: transparent; width: 100%;
  font-family: 'DM Sans', sans-serif; font-size: .86rem;
  color: var(--muted2); transition: all .18s; margin-bottom: 2px;
}
.user-item:hover { background: var(--bg3); color: var(--text); }
.user-item.active { background: var(--bg3); color: var(--text); }
.avi { width: 26px; height: 26px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: .72rem; font-weight: 700; flex-shrink: 0; }
.avi-s { background: var(--sam2); color: var(--sam); border: 1.5px solid var(--sam); }
.avi-p { background: var(--por2); color: var(--por); border: 1.5px solid var(--por); }
.active-dot { width: 7px; height: 7px; border-radius: 50%; margin-left: auto; }

/* MAIN */
.main { margin-left: 230px; flex: 1; display: flex; flex-direction: column; min-height: 100vh; }

/* TOPBAR */
.topbar {
  position: sticky; top: 0; z-index: 100;
  background: rgba(8,8,16,.88); backdrop-filter: blur(16px);
  border-bottom: 1px solid var(--border);
  display: flex; align-items: center; justify-content: space-between;
  padding: 14px 26px; gap: 14px;
}
.topbar-left { display: flex; align-items: center; gap: 12px; }
.hamburger {
  display: none; background: var(--bg3); border: 1px solid var(--border);
  color: var(--text); width: 34px; height: 34px; border-radius: var(--r3);
  cursor: pointer; font-size: 1.1rem; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.page-heading { font-size: 1.05rem; font-weight: 600; }
.page-sub { font-size: .72rem; color: var(--muted); margin-top: 1px; }
.topbar-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
.month-nav { display: flex; align-items: center; gap: 6px; }
.mnav-btn { background: var(--bg3); border: 1px solid var(--border); color: var(--text); width: 28px; height: 28px; border-radius: 7px; cursor: pointer; font-size: .9rem; transition: background .15s; }
.mnav-btn:hover { background: var(--border2); }
.mnav-label { font-size: .82rem; font-weight: 600; min-width: 90px; text-align: center; }

/* STATUS / CONNECTION */
.conn-badge {
  display: flex; align-items: center; gap: 5px;
  padding: 4px 10px; border-radius: 99px; font-size: .72rem;
  border: 1px solid var(--border); background: var(--bg3);
}
.conn-dot { width: 6px; height: 6px; border-radius: 50%; }
.conn-dot.ok { background: var(--green); box-shadow: 0 0 6px var(--green); }
.conn-dot.err { background: var(--red); }
.conn-dot.loading { background: var(--yellow); animation: blink .8s infinite; }
@keyframes blink { 0%,100%{opacity:1} 50%{opacity:.3} }

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.btn {
  display: inline-flex; align-items: center; gap: 6px;
  padding: 8px 16px; border-radius: var(--r3); border: none;
  cursor: pointer; font-family: 'DM Sans', sans-serif;
  font-size: .84rem; font-weight: 500; transition: all .18s;
  white-space: nowrap; line-height: 1;
}
.btn-primary { background: var(--sam); color: #fff; }
.btn-primary:hover { background: #6a5be8; transform: translateY(-1px); box-shadow: 0 4px 16px rgba(124,108,252,.3); }
.btn-ghost { background: var(--bg3); color: var(--text); border: 1px solid var(--border); }
.btn-ghost:hover { background: var(--bg4); }
.btn-danger { background: var(--red2); color: var(--red); border: 1px solid rgba(252,92,122,.25); }
.btn-sm { padding: 5px 12px; font-size: .77rem; border-radius: var(--r3); }
.btn-xs { padding: 3px 9px; font-size: .72rem; border-radius: 6px; }
.btn:disabled { opacity: .45; cursor: not-allowed; transform: none !important; }

/* ‚îÄ‚îÄ CONTENT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.content { padding: 24px 26px; flex: 1; }
.page { display: none; animation: fadeUp .28s ease; }
.page.active { display: block; }
@keyframes fadeUp { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; }
.g2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
.g3 { display: grid; grid-template-columns: repeat(3,1fr); gap: 14px; }
.g4 { display: grid; grid-template-columns: repeat(4,1fr); gap: 14px; }

/* STAT CARD */
.stat { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 18px; position: relative; overflow: hidden; transition: border-color .2s; }
.stat:hover { border-color: var(--border2); }
.stat-glow { position: absolute; top:-24px; right:-24px; width: 80px; height: 80px; border-radius: 50%; opacity: .06; pointer-events: none; }
.stat-icon { font-size: 1.4rem; margin-bottom: 12px; }
.stat-label { font-size: .7rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-bottom: 5px; }
.stat-val { font-family: 'Space Mono', monospace; font-size: 1.45rem; font-weight: 700; line-height: 1; }
.stat-val.g { color: var(--green); }
.stat-val.r { color: var(--red); }
.stat-val.p { color: var(--sam); }
.stat-val.o { color: var(--por); }
.stat-change { font-size: .72rem; color: var(--muted); margin-top: 5px; }

/* SECTION HDR */
.sec-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
.sec-title { font-size: .96rem; font-weight: 600; }
.sec-sub { font-size: .73rem; color: var(--muted); margin-top: 2px; }

/* ‚îÄ‚îÄ TRANSACTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.tx-list { display: flex; flex-direction: column; }
.tx-row {
  display: flex; align-items: center; gap: 12px;
  padding: 11px 12px; border-radius: 10px;
  transition: background .15s; cursor: pointer;
}
.tx-row:hover { background: var(--bg3); }
.tx-ico { width: 38px; height: 38px; border-radius: 11px; display: flex; align-items: center; justify-content: center; font-size: 1.05rem; flex-shrink: 0; }
.tx-info { flex: 1; min-width: 0; }
.tx-name-row { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
.tx-name { font-size: .86rem; font-weight: 500; }
.tx-meta { font-size: .7rem; color: var(--muted); margin-top: 2px; }
.tx-right { text-align: right; flex-shrink: 0; }
.tx-amt { font-family: 'Space Mono', monospace; font-size: .88rem; font-weight: 700; }
.tx-amt.income { color: var(--green); }
.tx-amt.expense { color: var(--red); }
.tx-amt.saving { color: var(--sam); }
.tx-half { font-size: .65rem; color: var(--muted); }
.tx-dot { width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0; }

/* PILL */
.pill { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 99px; font-size: .68rem; font-weight: 600; }
.pill.income  { background: var(--green2); color: var(--green); }
.pill.expense { background: var(--red2); color: var(--red); }
.pill.saving  { background: var(--sam2); color: var(--sam); }
.pill.shared  { background: var(--yellow2); color: var(--yellow); }

/* PROGRESS */
.prog-bar { height: 6px; background: var(--bg4); border-radius: 99px; overflow: hidden; }
.prog-fill { height: 100%; border-radius: 99px; transition: width .5s ease; }
.prog-labels { display: flex; justify-content: space-between; font-size: .7rem; color: var(--muted); margin-top: 4px; }

/* DEBT CARD */
.debt-card {
  background: linear-gradient(135deg, rgba(124,108,252,.08), rgba(252,108,160,.08));
  border: 1px solid rgba(124,108,252,.25); border-radius: var(--r); padding: 20px;
}
.debt-row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
.debt-person { text-align: center; }
.debt-avi { width: 46px; height: 46px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; margin: 0 auto 6px; }
.debt-name { font-size: .78rem; font-weight: 600; }
.debt-mid { flex: 1; text-align: center; }
.debt-amt { font-family: 'Space Mono', monospace; font-size: 1.4rem; font-weight: 700; color: var(--yellow); }
.debt-dir { font-size: .7rem; color: var(--muted); margin-top: 3px; }

/* BUDGET ITEM */
.budget-row { background: var(--bg3); border-radius: 11px; padding: 13px 14px; margin-bottom: 9px; }
.budget-hdr { display: flex; justify-content: space-between; align-items: center; margin-bottom: 9px; }
.budget-cat { display: flex; align-items: center; gap: 8px; font-size: .86rem; font-weight: 500; }
.budget-nums { font-family: 'Space Mono', monospace; font-size: .76rem; }

/* GOAL CARD */
.goal-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 20px; }
.goal-hdr { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 14px; }
.goal-emo { font-size: 2rem; }
.goal-title { font-size: .96rem; font-weight: 600; margin-bottom: 2px; }
.goal-tgt { font-size: .72rem; color: var(--muted); }
.goal-pct { font-family: 'Space Mono', monospace; font-size: 1.5rem; font-weight: 700; color: var(--sam); }

/* ACCOUNT CARD */
.acc-card { background: var(--bg2); border: 1px solid var(--border); border-radius: var(--r); padding: 20px; position: relative; overflow: hidden; }
.acc-type-label { font-size: .68rem; text-transform: uppercase; letter-spacing: .1em; color: var(--muted); margin-bottom: 4px; }
.acc-name { font-size: .95rem; font-weight: 600; margin-bottom: 14px; }
.acc-bal { font-family: 'Space Mono', monospace; font-size: 1.55rem; font-weight: 700; }
.acc-footer { display: flex; justify-content: space-between; margin-top: 14px; padding-top: 12px; border-top: 1px solid var(--border); }
.acc-stat { font-size: .72rem; color: var(--muted); }
.acc-stat span { display: block; font-weight: 600; color: var(--text); font-size: .82rem; margin-top: 2px; }

/* TABS */
.tabs { display: flex; gap: 3px; background: var(--bg3); padding: 4px; border-radius: 10px; margin-bottom: 18px; }
.tab { flex: 1; padding: 7px; text-align: center; border: none; background: transparent; color: var(--muted); font-family: 'DM Sans', sans-serif; font-size: .82rem; font-weight: 500; cursor: pointer; border-radius: 8px; transition: all .18s; }
.tab.active { background: var(--bg2); color: var(--text); box-shadow: 0 1px 4px rgba(0,0,0,.35); }

/* FILTERS */
.filter-bar { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; align-items: center; }
.filter-inp { display: flex; align-items: center; gap: 6px; background: var(--bg2); border: 1px solid var(--border); border-radius: 99px; padding: 6px 14px; flex: 1; min-width: 160px; }
.filter-inp input { background: none; border: none; outline: none; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .82rem; width: 100%; }
.filter-inp input::placeholder { color: var(--muted); }
.filter-sel { padding: 6px 12px; background: var(--bg2); border: 1px solid var(--border); border-radius: 99px; color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .8rem; outline: none; cursor: pointer; }
.filter-sel:focus { border-color: var(--sam); }
.filter-sel option { background: var(--bg2); }

/* CHART */
.chart-wrap { height: 130px; display: flex; flex-direction: column; }
.chart-bars { flex: 1; display: flex; align-items: flex-end; gap: 3px; }
.chart-bar-grp { flex: 1; display: flex; align-items: flex-end; gap: 1px; height: 100%; }
.chart-b { flex: 1; border-radius: 3px 3px 0 0; min-height: 2px; transition: opacity .18s; }
.chart-b:hover { opacity: .75; }
.chart-xlabels { display: flex; gap: 3px; padding-top: 6px; }
.chart-xl { flex: 1; font-size: .6rem; color: var(--muted); text-align: center; }

/* SPLIT DETAIL */
.split-detail { background: var(--bg3); border-radius: 11px; padding: 14px; margin-bottom: 8px; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
.overlay {
  position: fixed; inset: 0; background: rgba(0,0,0,.72);
  backdrop-filter: blur(5px); z-index: 500;
  display: none; align-items: center; justify-content: center; padding: 16px;
}
.overlay.open { display: flex; }
.modal {
  background: var(--bg2); border: 1px solid var(--border);
  border-radius: 18px; padding: 26px; width: 100%; max-width: 460px;
  max-height: 90dvh; overflow-y: auto;
  animation: modalIn .22s cubic-bezier(.34,1.56,.64,1);
}
@keyframes modalIn { from{opacity:0;transform:scale(.94) translateY(12px)} to{opacity:1;transform:scale(1) translateY(0)} }
.modal-hdr { display: flex; align-items: center; justify-content: space-between; margin-bottom: 22px; }
.modal-title { font-size: 1.05rem; font-weight: 700; }
.close-x { background: var(--bg3); border: none; color: var(--muted); cursor: pointer; width: 28px; height: 28px; border-radius: 7px; font-size: 1rem; transition: all .15s; }
.close-x:hover { color: var(--text); background: var(--bg4); }

/* FORM */
.fgrp { margin-bottom: 14px; }
.flabel { font-size: .73rem; color: var(--muted); display: block; margin-bottom: 6px; letter-spacing: .04em; }
.finput, .fsel {
  width: 100%; padding: 10px 13px;
  background: var(--bg3); border: 1px solid var(--border); border-radius: var(--r3);
  color: var(--text); font-family: 'DM Sans', sans-serif; font-size: .88rem;
  outline: none; transition: border-color .18s;
}
.finput:focus, .fsel:focus { border-color: var(--sam); }
.fsel option { background: var(--bg2); }
.finput::placeholder { color: var(--muted); }
.fgrid2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

/* TYPE SELECTOR */
.type-row { display: flex; gap: 7px; margin-bottom: 18px; }
.type-opt {
  flex: 1; padding: 10px 6px; border-radius: var(--r3); border: 1px solid var(--border);
  background: var(--bg3); cursor: pointer; text-align: center;
  font-size: .8rem; font-weight: 500; color: var(--muted); transition: all .18s;
}
.type-opt.sel-income  { border-color: var(--green); background: var(--green2); color: var(--green); }
.type-opt.sel-expense { border-color: var(--red);   background: var(--red2);   color: var(--red); }
.type-opt.sel-saving  { border-color: var(--sam);   background: var(--sam2);   color: var(--sam); }

/* TOGGLE */
.toggle-row {
  display: flex; align-items: center; gap: 10px;
  padding: 11px 13px; background: var(--bg3);
  border: 1px solid var(--border); border-radius: var(--r3);
  cursor: pointer; margin-bottom: 14px;
}
.toggle-sw { width: 34px; height: 18px; background: var(--border); border-radius: 99px; position: relative; transition: background .18s; flex-shrink: 0; }
.toggle-sw.on { background: var(--sam); }
.toggle-knob { width: 12px; height: 12px; background: white; border-radius: 50%; position: absolute; top: 3px; left: 3px; transition: left .18s; }
.toggle-sw.on .toggle-knob { left: 19px; }

/* SPLIT PERSONS */
.split-persons { display: flex; gap: 10px; }
.sp-btn {
  flex: 1; padding: 11px 8px; border-radius: var(--r3); border: 1px solid var(--border);
  background: var(--bg2); cursor: pointer; text-align: center; transition: all .18s;
}
.sp-btn.active-s { border-color: var(--sam); background: var(--sam2); }
.sp-btn.active-p { border-color: var(--por); background: var(--por2); }
.sp-btn .sp-avi { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: .8rem; margin: 0 auto 5px; }
.sp-btn .sp-name { font-size: .78rem; font-weight: 600; }
.sp-btn .sp-share { font-family: 'Space Mono', monospace; font-size: .88rem; font-weight: 700; margin-top: 3px; }

/* LOADING SKELETON */
.skeleton { background: linear-gradient(90deg, var(--bg3) 25%, var(--bg4) 50%, var(--bg3) 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 8px; }
@keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }

/* EMPTY */
.empty { text-align: center; padding: 36px 20px; color: var(--muted); }
.empty .emo { font-size: 2.2rem; margin-bottom: 8px; }
.empty p { font-size: .84rem; }

/* TOAST */
#toast {
  position: fixed; bottom: 22px; right: 22px;
  background: var(--bg3); border: 1px solid var(--border);
  border-radius: 12px; padding: 11px 16px;
  font-size: .83rem; z-index: 9999;
  display: none; align-items: center; gap: 8px;
  box-shadow: 0 8px 28px rgba(0,0,0,.5);
  animation: toastIn .25s ease; max-width: 290px;
}
@keyframes toastIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
#toast.ok { border-color: rgba(61,252,180,.3); }
#toast.err { border-color: rgba(252,92,122,.3); }

/* SIDEBAR OVERLAY (mobile) */
.sb-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,.65); z-index: 199; }
.sb-overlay.show { display: block; }

/* FULL-PAGE LOADER */
#page-loader {
  position: fixed; inset: 0; background: var(--bg);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  z-index: 9999; gap: 14px;
}
.loader-logo { font-family: 'Space Mono', monospace; font-size: 1.3rem; font-weight: 700; background: linear-gradient(120deg, var(--sam), var(--por)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.loader-spin { width: 28px; height: 28px; border: 2px solid var(--border); border-top-color: var(--sam); border-radius: 50%; animation: spin .7s linear infinite; }
@keyframes spin { to{transform:rotate(360deg)} }
.loader-msg { font-size: .78rem; color: var(--muted); }

/* SETUP SCREEN */
#setup-screen {
  position: fixed; inset: 0; background: var(--bg);
  display: none; align-items: center; justify-content: center; z-index: 9998; padding: 24px;
}
.setup-box { background: var(--bg2); border: 1px solid var(--border); border-radius: 20px; padding: 32px; max-width: 440px; width: 100%; }
.setup-title { font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
.setup-sub { font-size: .83rem; color: var(--muted); margin-bottom: 22px; line-height: 1.5; }
.setup-step { background: var(--bg3); border-radius: var(--r3); padding: 12px 14px; margin-bottom: 10px; }
.setup-step-num { font-size: .65rem; color: var(--muted); letter-spacing: .08em; text-transform: uppercase; margin-bottom: 5px; }
.setup-step-text { font-size: .84rem; }
.setup-step code { font-family: 'Space Mono', monospace; background: var(--bg4); border-radius: 4px; padding: 1px 6px; font-size: .78rem; color: var(--sam); }

/* Misc */
.mb4{margin-bottom:4px} .mb8{margin-bottom:8px} .mb14{margin-bottom:14px} .mb18{margin-bottom:18px} .mb24{margin-bottom:24px}
.mt8{margin-top:8px} .mt14{margin-top:14px} .mt18{margin-top:18px}
.flex{display:flex} .items-c{align-items:center} .jc-b{justify-content:space-between}
.gap8{gap:8px} .gap12{gap:12px} .fw6{font-weight:600} .muted{color:var(--muted)} .w100{width:100%}
.mono{font-family:'Space Mono',monospace}

/* RESPONSIVE */
@media(max-width:900px) { .g4{grid-template-columns:1fr 1fr} .g3{grid-template-columns:1fr 1fr} }
@media(max-width:680px) {
  .sidebar{transform:translateX(-100%)} .sidebar.open{transform:translateX(0)}
  .main{margin-left:0} .hamburger{display:flex} .content{padding:16px 14px}
  .topbar{padding:12px 14px} .g4,.g3,.g2{grid-template-columns:1fr}
  .mnav-label{min-width:75px; font-size:.76rem}
}
::-webkit-scrollbar{width:4px;height:4px} ::-webkit-scrollbar-thumb{background:var(--border);border-radius:99px}
</style>
</head>
<body>

<!-- PAGE LOADER -->
<div id="page-loader">
  <div class="loader-logo">SAM & POR</div>
  <div class="loader-spin"></div>
  <div class="loader-msg" id="loader-msg">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets...</div>
</div>

<!-- SETUP SCREEN -->
<div id="setup-screen">
  <div class="setup-box">
    <div style="text-align:center;margin-bottom:20px">
      <div style="font-family:'Space Mono',monospace;font-size:1.4rem;font-weight:700;background:linear-gradient(120deg,#7c6cfc,#fc6ca0);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:4px">SAM & POR</div>
      <div style="font-size:.78rem;color:var(--muted)">Finance Tracker</div>
    </div>
    <div class="setup-title" style="font-size:1rem;margin-bottom:6px">üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets</div>
    <div class="setup-sub">‡∏Å‡∏£‡∏≠‡∏Å Apps Script URL ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏±‡∏ö Google Sheets<br>‡∏î‡∏π‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà <code>README.md</code></div>
    <div style="display:flex;flex-direction:column;gap:8px;margin-bottom:18px">
      <div class="setup-step">
        <div class="setup-step-num">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 1</div>
        <div class="setup-step-text">‡πÄ‡∏õ‡∏¥‡∏î Google Sheets ‚Üí <b>Extensions ‚Üí Apps Script</b><br>‡∏ß‡∏≤‡∏á code ‡∏à‡∏≤‡∏Å <code>Code.gs</code> ‚Üí ‡∏Å‡∏î Save ‚Üí ‡∏£‡∏±‡∏ô <code>setupSheets()</code></div>
      </div>
      <div class="setup-step">
        <div class="setup-step-num">‡∏Ç‡∏±‡πâ‡∏ô‡∏ó‡∏µ‡πà 2</div>
        <div class="setup-step-text"><b>Deploy ‚Üí New deployment ‚Üí Web App</b><br><code>Execute as: Me</code> ¬∑ <code>Access: Anyone</code> ‚Üí Copy URL</div>
      </div>
    </div>
    <div class="fgrp">
      <label class="flabel">Apps Script Web App URL</label>
      <input type="url" class="finput" id="api-url-input" placeholder="https://script.google.com/macros/s/AKfy.../exec" autocomplete="off">
      <div style="font-size:.7rem;color:var(--muted);margin-top:5px">URL ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô browser ‡∏ô‡∏µ‡πâ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</div>
    </div>
    <button class="btn btn-primary w100 mt8" onclick="saveApiUrl()" id="connect-btn">
      üîó ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets
    </button>
    <div style="display:flex;align-items:center;gap:10px;margin:14px 0;color:var(--muted);font-size:.75rem">
      <div style="flex:1;height:1px;background:var(--border)"></div>
      ‡∏´‡∏£‡∏∑‡∏≠‡∏ó‡∏î‡∏•‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô
      <div style="flex:1;height:1px;background:var(--border)"></div>
    </div>
    <button class="btn btn-ghost w100" onclick="useMockData()">
      ‚ñ∂ ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Demo (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤)
    </button>
  </div>
</div>

<!-- APP -->
<div class="app" id="app" style="display:none">
  <aside class="sidebar" id="sidebar">
    <div class="sidebar-brand">
      <div class="brand-name">SAM & POR</div>
      <div class="brand-sub">üí∏ Finance Tracker</div>
    </div>
    <nav>
      <div class="nav-group">
        <span class="nav-group-label">‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</span>
        <div class="nav-link active" data-page="dashboard"><span class="nav-icon">üè†</span>Dashboard</div>
        <div class="nav-link" data-page="transactions"><span class="nav-icon">üí≥</span>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
        <div class="nav-link" data-page="split"><span class="nav-icon">‚öñÔ∏è</span>‡∏´‡∏≤‡∏£‡∏ö‡∏¥‡∏• <span class="nav-badge" id="split-badge" style="display:none">!</span></div>
      </div>
      <div class="nav-group" style="margin-top:6px">
        <span class="nav-group-label">‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£</span>
        <div class="nav-link" data-page="budget"><span class="nav-icon">üéØ</span>‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
        <div class="nav-link" data-page="savings"><span class="nav-icon">üå¥</span>‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
        <div class="nav-link" data-page="accounts"><span class="nav-icon">üè¶</span>‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
      </div>
    </nav>
    <div class="sidebar-footer">
      <div class="user-label">‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏õ‡πá‡∏ô</div>
      <button class="user-item active" id="ubtn-SAM" onclick="switchUser('SAM')">
        <div class="avi avi-s">S</div> SAM
        <div class="active-dot" style="background:var(--sam)"></div>
      </button>
      <button class="user-item" id="ubtn-POR" onclick="switchUser('POR')">
        <div class="avi avi-p">P</div> POR
        <div class="active-dot"></div>
      </button>
    </div>
  </aside>
  <div class="sb-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

  <main class="main">
    <header class="topbar">
      <div class="topbar-left">
        <button class="hamburger" id="hamburger" onclick="openSidebar()">‚ò∞</button>
        <div>
          <div class="page-heading" id="page-heading">Dashboard</div>
          <div class="page-sub" id="page-sub"></div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="conn-badge" id="conn-badge">
          <div class="conn-dot loading" id="conn-dot"></div>
          <span id="conn-text">‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span>
        </div>
        <div class="month-nav">
          <button class="mnav-btn" onclick="changeMonth(-1)">‚Äπ</button>
          <div class="mnav-label" id="mnav-label"></div>
          <button class="mnav-btn" onclick="changeMonth(1)">‚Ä∫</button>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openAddTx()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
      </div>
    </header>

    <div class="content">
      <!-- DASHBOARD -->
      <div class="page active" id="pg-dashboard">
        <div class="g4 mb24" id="dash-stats"></div>
        <div class="g2 mb24">
          <div>
            <div class="sec-hdr"><div><div class="sec-title">üí≥ ‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏ô‡∏µ‡πâ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏Å‡∏±‡∏ô</div><div class="sec-sub">‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°</div></div></div>
            <div class="debt-card" id="dash-debt">
              <div class="skeleton" style="height:90px;border-radius:10px"></div>
            </div>
          </div>
          <div>
            <div class="sec-hdr"><div><div class="sec-title">üìä ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö vs ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div><div class="sec-sub">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div></div></div>
            <div class="card" style="padding:14px 16px">
              <div class="chart-wrap" id="dash-chart">
                <div class="skeleton" style="height:120px;border-radius:8px"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="g2">
          <div>
            <div class="sec-hdr">
              <div><div class="sec-title">üïê ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</div></div>
              <button class="btn btn-ghost btn-sm" onclick="goPage('transactions')">‡∏î‡∏π‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Üí</button>
            </div>
            <div class="card" style="padding:10px">
              <div class="tx-list" id="dash-recent">
                <div class="skeleton mb8" style="height:46px"></div>
                <div class="skeleton mb8" style="height:46px"></div>
                <div class="skeleton" style="height:46px"></div>
              </div>
            </div>
          </div>
          <div>
            <div class="sec-hdr">
              <div><div class="sec-title">üéØ ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div></div>
              <button class="btn btn-ghost btn-sm" onclick="goPage('budget')">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£ ‚Üí</button>
            </div>
            <div id="dash-budget">
              <div class="skeleton mb8" style="height:60px;border-radius:11px"></div>
              <div class="skeleton mb8" style="height:60px;border-radius:11px"></div>
              <div class="skeleton" style="height:60px;border-radius:11px"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- TRANSACTIONS -->
      <div class="page" id="pg-transactions">
        <div class="filter-bar">
          <div class="filter-inp">üîç <input type="text" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤..." id="search-q" oninput="renderTxPage()"></div>
          <select class="filter-sel" id="sel-type" onchange="renderTxPage()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
            <option value="income">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
            <option value="expense">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
            <option value="saving">üå¥ ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</option>
          </select>
          <select class="filter-sel" id="sel-user" onchange="renderTxPage()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô</option>
            <option value="SAM">SAM</option>
            <option value="POR">POR</option>
          </select>
          <select class="filter-sel" id="sel-cat" onchange="renderTxPage()">
            <option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>
          </select>
          <button class="btn btn-ghost btn-sm" onclick="refreshAll()">üîÑ ‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        </div>
        <div class="g3 mb18" id="tx-summary"></div>
        <div class="card" style="padding:10px">
          <div class="tx-list" id="tx-main-list"></div>
        </div>
      </div>

      <!-- SPLIT -->
      <div class="page" id="pg-split">
        <div class="g2 mb24">
          <div>
            <div class="sec-hdr"><div class="sec-title">üí∞ ‡∏™‡∏£‡∏∏‡∏õ‡∏¢‡∏≠‡∏î‡∏´‡∏ô‡∏µ‡πâ</div></div>
            <div class="debt-card" id="split-debt"></div>
          </div>
          <div>
            <div class="sec-hdr"><div class="sec-title">üìà ‡∏™‡∏ñ‡∏¥‡∏ï‡∏¥‡∏Ñ‡πà‡∏≤‡∏£‡πà‡∏ß‡∏°</div></div>
            <div class="card" id="split-stats"></div>
          </div>
        </div>
        <div class="sec-hdr mb14">
          <div class="sec-title">üßæ ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°</div>
          <button class="btn btn-primary btn-sm" onclick="openAddTx(true)">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°</button>
        </div>
        <div class="card" style="padding:10px"><div class="tx-list" id="split-list"></div></div>
      </div>

      <!-- BUDGET -->
      <div class="page" id="pg-budget">
        <div class="sec-hdr mb18">
          <div></div>
          <button class="btn btn-primary btn-sm" onclick="openBudgetModal()">+ ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö</button>
        </div>
        <div id="budget-main"></div>
      </div>

      <!-- SAVINGS -->
      <div class="page" id="pg-savings">
        <div class="flex items-c jc-b mb18">
          <div class="stat" style="padding:14px 20px;border:none;background:linear-gradient(135deg,rgba(124,108,252,.12),rgba(61,252,180,.06))">
            <div class="stat-label">‡∏≠‡∏≠‡∏°‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            <div class="stat-val p" id="total-saved-val">‡∏ø0</div>
          </div>
          <button class="btn btn-primary btn-sm" onclick="openGoalModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
        </div>
        <div class="g2" id="savings-main"></div>
      </div>

      <!-- ACCOUNTS -->
      <div class="page" id="pg-accounts">
        <div class="sec-hdr mb18">
          <div></div>
          <button class="btn btn-primary btn-sm" onclick="openAccModal()">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
        </div>
        <div class="g3" id="accounts-main"></div>
      </div>
    </div>
  </main>
</div>

<!-- ============ MODALS ============ -->

<!-- ADD / EDIT TX -->
<div class="overlay" id="mo-tx">
  <div class="modal">
    <div class="modal-hdr">
      <div class="modal-title" id="mo-tx-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
      <button class="close-x" onclick="closeModal('mo-tx')">‚úï</button>
    </div>
    <div class="type-row">
      <div class="type-opt sel-income" data-t="income" onclick="selType('income')">üí∞ ‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div>
      <div class="type-opt" data-t="expense" onclick="selType('expense')">üí∏ ‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div>
      <div class="type-opt" data-t="saving" onclick="selType('saving')">üå¥ ‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô</div>
    </div>
    <div class="fgrp"><label class="flabel">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input class="finput" id="f-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß, ‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"></div>
    <div class="fgrp"><label class="flabel">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô (‡∏ø)</label><input type="number" class="finput" id="f-amount" placeholder="0" oninput="updateSplitPreview()"></div>
    <div class="fgrid2 mb14">
      <div class="fgrp" style="margin:0"><label class="flabel">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" class="finput" id="f-date"></div>
      <div class="fgrp" style="margin:0"><label class="flabel">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select class="fsel" id="f-cat"></select></div>
    </div>
    <div class="fgrp"><label class="flabel">‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><select class="fsel" id="f-account"></select></div>
    <div class="toggle-row" onclick="toggleShared()">
      <div class="toggle-sw" id="tgl-shared"><div class="toggle-knob"></div></div>
      <div><div style="font-size:.84rem;font-weight:500">‡∏´‡∏≤‡∏£‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°</div><div style="font-size:.71rem;color:var(--muted)">‡πÅ‡∏ö‡πà‡∏á‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á SAM & POR</div></div>
    </div>
    <div id="split-ui" style="display:none;margin-bottom:14px">
      <div class="split-persons mb8" id="split-persons">
        <div class="sp-btn active-s" id="sp-SAM" onclick="toggleSP('SAM')">
          <div class="sp-avi avi-s">S</div>
          <div class="sp-name" style="color:var(--sam)">SAM</div>
          <div class="sp-share" style="color:var(--sam)" id="sp-SAM-amt">‡∏ø0</div>
        </div>
        <div style="display:flex;align-items:center;color:var(--muted)">√∑</div>
        <div class="sp-btn active-p" id="sp-POR" onclick="toggleSP('POR')">
          <div class="sp-avi avi-p">P</div>
          <div class="sp-name" style="color:var(--por)">POR</div>
          <div class="sp-share" style="color:var(--por)" id="sp-POR-amt">‡∏ø0</div>
        </div>
      </div>
      <div class="fgrp" style="margin:0"><label class="flabel">‡πÉ‡∏Ñ‡∏£‡∏à‡πà‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô</label>
        <select class="fsel" id="f-paidby"><option value="SAM">SAM</option><option value="POR">POR</option></select>
      </div>
    </div>
    <div class="fgrp"><label class="flabel">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input class="finput" id="f-note" placeholder="‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°..."></div>
    <div class="flex gap8 mt8">
      <button class="btn btn-primary w100" id="save-tx-btn" onclick="saveTx()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
      <button class="btn btn-danger" id="del-tx-btn" style="display:none" onclick="deleteTx()">üóëÔ∏è</button>
    </div>
  </div>
</div>

<!-- BUDGET -->
<div class="overlay" id="mo-budget">
  <div class="modal" style="max-width:380px">
    <div class="modal-hdr">
      <div class="modal-title">‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</div>
      <button class="close-x" onclick="closeModal('mo-budget')">‚úï</button>
    </div>
    <div class="fgrp"><label class="flabel">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select class="fsel" id="b-cat"></select></div>
    <div class="fgrp"><label class="flabel">‡∏á‡∏ö‡∏ï‡πà‡∏≠‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡∏ø)</label><input type="number" class="finput" id="b-amt" placeholder="0"></div>
    <button class="btn btn-primary w100 mt8" onclick="saveBudget()">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
  </div>
</div>

<!-- GOAL -->
<div class="overlay" id="mo-goal">
  <div class="modal" style="max-width:380px">
    <div class="modal-hdr">
      <div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏≠‡∏≠‡∏°</div>
      <button class="close-x" onclick="closeModal('mo-goal')">‚úï</button>
    </div>
    <div class="fgrp"><label class="flabel">‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</label><input class="finput" id="g-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß, ‡∏ã‡∏∑‡πâ‡∏≠‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠"></div>
    <div class="fgrp"><label class="flabel">‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô</label><input class="finput" id="g-icon" value="üéØ" placeholder="üéØ" style="width:80px"></div>
    <div class="fgrp"><label class="flabel">‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢ (‡∏ø)</label><input type="number" class="finput" id="g-target" placeholder="0"></div>
    <button class="btn btn-primary w100 mt8" onclick="saveGoal()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</button>
  </div>
</div>

<!-- ACCOUNT -->
<div class="overlay" id="mo-acc">
  <div class="modal" style="max-width:380px">
    <div class="modal-hdr">
      <div class="modal-title">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div>
      <button class="close-x" onclick="closeModal('mo-acc')">‚úï</button>
    </div>
    <div class="fgrp"><label class="flabel">‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</label><input class="finput" id="a-name" placeholder="‡πÄ‡∏ä‡πà‡∏ô KBank SAM"></div>
    <div class="fgrp"><label class="flabel">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
      <select class="fsel" id="a-type">
        <option value="‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</option>
        <option value="‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£">üè¶ ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£</option>
        <option value="Wallet">üì± Wallet</option>
      </select>
    </div>
    <div class="fgrp"><label class="flabel">‡∏¢‡∏≠‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏ø)</label><input type="number" class="finput" id="a-bal" placeholder="0"></div>
    <div class="fgrp"><label class="flabel">‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á</label>
      <select class="fsel" id="a-owner">
        <option value="SAM">SAM</option>
        <option value="POR">POR</option>
        <option value="‡∏£‡πà‡∏ß‡∏°">‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô</option>
      </select>
    </div>
    <button class="btn btn-primary w100 mt8" onclick="saveAcc()">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</button>
  </div>
</div>

<div id="toast"></div>

<script>
// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   CONFIG & STATE                                      ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
let API_URL = localStorage.getItem('finance_api_url') || '';
let USE_MOCK = false;

let currentUser = 'SAM';
let currentMonth = new Date(); // JS Date
let editingId = null;
let selTypeVal = 'income';
let sharedOn = false;

// Cached data
let cache = { transactions:[], accounts:[], budgets:[], savings:[] };

const CATS = {
  income:  ['‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô','Freelance','‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô'],
  expense: ['‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£','‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á','‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á','‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ','‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á','‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û','‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'],
  saving:  ['‡∏≠‡∏≠‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß','‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á','‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà','‡∏•‡∏á‡∏ó‡∏∏‡∏ô'],
};
const ICONS = { '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô':'üíº','Freelance':'üíª','‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç':'üéÅ','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô':'üí∞','‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£':'üçú','‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':'üöå','‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á':'üõçÔ∏è','‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ':'‚ö°','‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á':'üéÆ','‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û':'üíä','‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß':'üß¥','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°':'ü§ù','‡∏≠‡∏∑‡πà‡∏ô‡πÜ':'üìå','‡∏≠‡∏≠‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß':'‚úàÔ∏è','‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á':'üõ°Ô∏è','‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà':'üì¶','‡∏•‡∏á‡∏ó‡∏∏‡∏ô':'üìà' };
const COLS = { '‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô':'#3dfcb4','Freelance':'#3dfcb4','‡∏Ç‡∏≠‡∏á‡∏Ç‡∏ß‡∏±‡∏ç':'#3dfcb4','‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏≠‡∏∑‡πà‡∏ô':'#3dfcb4','‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£':'#fc8c5c','‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á':'#fc6ca0','‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á':'#e87cfc','‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ':'#fcd03d','‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á':'#7c6cfc','‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û':'#fc5c7a','‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß':'#5caafc','‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°':'#fcd03d','‡∏≠‡∏∑‡πà‡∏ô‡πÜ':'#7878a0','‡∏≠‡∏≠‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß':'#7c6cfc','‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á':'#3dfcb4','‡∏ã‡∏∑‡πâ‡∏≠‡∏Ç‡∏≠‡∏á‡πÉ‡∏´‡∏ç‡πà':'#fc8c5c','‡∏•‡∏á‡∏ó‡∏∏‡∏ô':'#5caafc' };
const MONTHS_SHORT = ['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
const MONTHS_FULL = ['‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå','‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°','‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô','‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°','‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô','‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°','‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°','‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô','‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°','‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô','‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'];

// MOCK DATA
const MOCK = {
  transactions: [
    {id:'m1',name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',amount:35000,type:'income',category:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',date:'2026-02-01',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
    {id:'m2',name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',amount:28000,type:'income',category:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',date:'2026-02-01',user:'POR',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',note:'',shared:false,paidBy:''},
    {id:'m3',name:'‡∏Ñ‡πà‡∏≤‡∏Ç‡πâ‡∏≤‡∏ß‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á',amount:320,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',date:'2026-02-03',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'‡∏Ç‡πâ‡∏≤‡∏ß‡∏ú‡∏±‡∏î',shared:false,paidBy:''},
    {id:'m4',name:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏ö‡πâ‡∏≤‡∏ô',amount:699,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ',date:'2026-02-05',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:true,paidBy:'SAM'},
    {id:'m5',name:'‡πÑ‡∏õ‡∏Å‡∏¥‡∏ô Sushi',amount:1800,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',date:'2026-02-07',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î',shared:true,paidBy:'SAM'},
    {id:'m6',name:'‡∏≠‡∏≠‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô',amount:3000,type:'saving',category:'‡∏≠‡∏≠‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß',date:'2026-02-10',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
    {id:'m7',name:'‡∏Ñ‡πà‡∏≤‡∏Ñ‡∏≠‡∏ô‡πÇ‡∏î',amount:8000,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏π‡∏õ‡πÇ‡∏†‡∏Ñ',date:'2026-02-10',user:'POR',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',note:'',shared:true,paidBy:'POR'},
    {id:'m8',name:'‡∏ä‡πâ‡∏≠‡∏õ Shopee',amount:1250,type:'expense',category:'‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',date:'2026-02-12',user:'POR',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',note:'‡∏Ç‡∏≠‡∏á‡πÉ‡∏ä‡πâ',shared:false,paidBy:''},
    {id:'m9',name:'‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á',amount:2000,type:'saving',category:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á',date:'2026-02-14',user:'POR',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',note:'',shared:false,paidBy:''},
    {id:'m10',name:'‡∏Ñ‡πà‡∏≤‡∏´‡∏°‡∏≠',amount:500,type:'expense',category:'‡∏™‡∏∏‡∏Ç‡∏†‡∏≤‡∏û',date:'2026-02-15',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
    {id:'m11',name:'‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡πÅ‡∏ü',amount:180,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',date:'2026-01-28',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
    {id:'m12',name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô Jan',amount:35000,type:'income',category:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',date:'2026-01-01',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
    {id:'m13',name:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô Jan',amount:28000,type:'income',category:'‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô',date:'2026-01-01',user:'POR',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',note:'',shared:false,paidBy:''},
    {id:'m14',name:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£ Jan',amount:4200,type:'expense',category:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',date:'2026-01-15',user:'SAM',account:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',note:'',shared:false,paidBy:''},
  ],
  accounts: [
    {id:'a1',name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ SAM',type:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',balance:15000,owner:'SAM'},
    {id:'a2',name:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤ POR',type:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î',balance:12000,owner:'POR'},
    {id:'a3',name:'KBank SAM',type:'‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£',balance:45000,owner:'SAM'},
    {id:'a4',name:'SCB POR',type:'‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£',balance:32000,owner:'POR'},
    {id:'a5',name:'TrueMoney Wallet',type:'Wallet',balance:850,owner:'‡∏£‡πà‡∏ß‡∏°'},
  ],
  budgets: [
    {id:'b1',category:'‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£',amount:5000,month:'2026-02'},
    {id:'b2',category:'‡∏ä‡πá‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á',amount:3000,month:'2026-02'},
    {id:'b3',category:'‡∏Ñ‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á',amount:2000,month:'2026-02'},
    {id:'b4',category:'‡∏Ñ‡πà‡∏≤‡∏ö‡∏±‡∏ô‡πÄ‡∏ó‡∏¥‡∏á',amount:1500,month:'2026-02'},
  ],
  savings: [
    {id:'s1',name:'‡∏ç‡∏µ‡πà‡∏õ‡∏∏‡πà‡∏ô 2026',icon:'‚úàÔ∏è',target:80000,saved:28000},
    {id:'s2',name:'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô',icon:'üõ°Ô∏è',target:100000,saved:45000},
    {id:'s3',name:'‡∏ã‡∏∑‡πâ‡∏≠‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Å',icon:'üíª',target:35000,saved:12000},
  ],
};

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   API LAYER ‚Äî fetch() (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Browser) ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù

async function api(action, params = {}, method = 'GET', body = null) {
  if (USE_MOCK) return mockApi(action, body || params);

  if (method === 'GET') {
    const url = new URL(API_URL);
    url.searchParams.set('action', action);
    Object.entries(params).forEach(([k, v]) => url.searchParams.set(k, String(v)));
    const res = await fetch(url.toString());
    const json = await res.json();
    if (json.status === 'error') throw new Error(json.message);
    return json;
  }

  // POST
  const res = await fetch(API_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'text/plain' }, // text/plain bypasses CORS preflight
    body: JSON.stringify({ action, ...body }),
  });
  const json = await res.json();
  if (json.status === 'error') throw new Error(json.message);
  return json;
}

// MOCK API handler
function mockApi(action, body) {
  const m = currentMonthStr();
  switch(action) {
    case 'getTransactions': {
      let data = [...MOCK.transactions];
      if (body.month) data = data.filter(t => t.date.startsWith(body.month));
      if (body.user) data = data.filter(t => t.user === body.user);
      if (body.type) data = data.filter(t => t.type === body.type);
      return { status:'ok', data: data.sort((a,b)=>new Date(b.date)-new Date(a.date)) };
    }
    case 'getAccounts': return { status:'ok', data: MOCK.accounts };
    case 'getBudgets': return { status:'ok', data: MOCK.budgets };
    case 'getSavings': return { status:'ok', data: MOCK.savings };
    case 'addTransaction': {
      const id = 'tx_' + Date.now();
      MOCK.transactions.push({ id, ...body, shared: !!body.shared, paidBy: body.paidBy||'' });
      return { status:'ok', id };
    }
    case 'updateTransaction': {
      const i = MOCK.transactions.findIndex(t => t.id === body.id);
      if (i >= 0) Object.assign(MOCK.transactions[i], body);
      return { status:'ok' };
    }
    case 'deleteTransaction': {
      const i = MOCK.transactions.findIndex(t => t.id === body.id);
      if (i >= 0) MOCK.transactions.splice(i, 1);
      return { status:'ok' };
    }
    case 'setBudget': {
      const i = MOCK.budgets.findIndex(b => b.category === body.category);
      if (i >= 0) MOCK.budgets[i].amount = body.amount;
      else MOCK.budgets.push({ id:'b_'+Date.now(), category:body.category, amount:body.amount, month:m });
      return { status:'ok' };
    }
    case 'deleteBudget': {
      const i = MOCK.budgets.findIndex(b => b.id === body.id);
      if (i >= 0) MOCK.budgets.splice(i, 1);
      return { status:'ok' };
    }
    case 'addSavingGoal': {
      const id = 'sg_'+Date.now();
      MOCK.savings.push({ id, name:body.name, icon:body.icon||'üéØ', target:body.target, saved:0 });
      return { status:'ok', id };
    }
    case 'addToSaving': {
      const g = MOCK.savings.find(s => s.id === body.id);
      if (g) g.saved += body.amount;
      return { status:'ok' };
    }
    case 'deleteSavingGoal': {
      const i = MOCK.savings.findIndex(s => s.id === body.id);
      if (i >= 0) MOCK.savings.splice(i, 1);
      return { status:'ok' };
    }
    case 'addAccount': {
      MOCK.accounts.push({ id:'a_'+Date.now(), name:body.name, type:body.type, balance:body.balance||0, owner:body.owner });
      return { status:'ok' };
    }
    default: return { status:'error', message:'Unknown action' };
  }
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   INIT                                                ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
window.addEventListener('load', async () => {
  currentMonth = new Date(2026, 1, 1); // start at Feb 2026
  updateMonthDisplay();

  if (!API_URL) {
    document.getElementById('page-loader').style.display = 'none';
    document.getElementById('setup-screen').style.display = 'flex';
    return;
  }
  await initApp();
});

async function saveApiUrl() {
  const url = document.getElementById('api-url-input').value.trim();
  if (!url || !url.startsWith('https://')) { toast('URL ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'err'); return; }
  localStorage.setItem('finance_api_url', url);
  API_URL = url;
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('page-loader').style.display = 'flex';
  await initApp();
}

async function useMockData() {
  USE_MOCK = true;
  document.getElementById('setup-screen').style.display = 'none';
  document.getElementById('page-loader').style.display = 'flex';
  await initApp();
}

async function initApp() {
  setConnStatus('loading', '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
  try {
    await refreshAll();
    document.getElementById('page-loader').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    setConnStatus('ok', USE_MOCK ? 'Demo Mode' : 'Google Sheets ‚úì');
    renderDashboard();
  } catch(e) {
    document.getElementById('page-loader').style.display = 'none';
    document.getElementById('setup-screen').style.display = 'flex';
    document.getElementById('api-url-input').value = API_URL;
    toast('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'err');
    setConnStatus('err', '‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ');
  }
}

async function refreshAll() {
  const [txRes, accRes, budRes, savRes] = await Promise.all([
    api('getTransactions', {}),
    api('getAccounts'),
    api('getBudgets'),
    api('getSavings'),
  ]);
  cache.transactions = txRes.data || [];
  cache.accounts = accRes.data || [];
  cache.budgets = budRes.data || [];
  cache.savings = savRes.data || [];
  updateCatFilter();
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   NAVIGATION                                          ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function goPage(name, el) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));
  document.getElementById('pg-' + name)?.classList.add('active');
  if (el) el.classList.add('active');
  else document.querySelector(`.nav-link[data-page="${name}"]`)?.classList.add('active');

  const titles = { dashboard:'Dashboard', transactions:'‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', split:'‡∏´‡∏≤‡∏£‡∏ö‡∏¥‡∏•', budget:'‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì', savings:'‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô', accounts:'‡∏ö‡∏±‡∏ç‡∏ä‡∏µ' };
  document.getElementById('page-heading').textContent = titles[name] || name;
  document.getElementById('page-sub').textContent = currentMonthFull();
  closeSidebar();

  if (name === 'dashboard') renderDashboard();
  else if (name === 'transactions') renderTxPage();
  else if (name === 'split') renderSplit();
  else if (name === 'budget') renderBudget();
  else if (name === 'savings') renderSavings();
  else if (name === 'accounts') renderAccounts();
}

document.querySelectorAll('.nav-link').forEach(link => {
  link.addEventListener('click', function() { goPage(this.dataset.page, this); });
});

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   MONTH                                               ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function changeMonth(d) {
  currentMonth = new Date(currentMonth.getFullYear(), currentMonth.getMonth() + d, 1);
  updateMonthDisplay();
  renderActivePage();
}
function updateMonthDisplay() {
  document.getElementById('mnav-label').textContent = MONTHS_SHORT[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear();
  document.getElementById('page-sub').textContent = currentMonthFull();
}
function currentMonthStr() { return currentMonth.getFullYear() + '-' + String(currentMonth.getMonth()+1).padStart(2,'0'); }
function currentMonthFull() { return MONTHS_FULL[currentMonth.getMonth()] + ' ' + currentMonth.getFullYear(); }
function renderActivePage() {
  const active = document.querySelector('.page.active')?.id.replace('pg-','');
  if (active) goPage(active);
}
function getMonthlyTx() { const m = currentMonthStr(); return cache.transactions.filter(t => t.date.startsWith(m)); }

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   DASHBOARD                                           ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderDashboard() {
  const tx = getMonthlyTx();
  const income = sum(tx,'income'), expense = sum(tx,'expense'), saving = sum(tx,'saving');
  const totalBal = cache.accounts.reduce((a,b) => a+b.balance, 0);

  document.getElementById('dash-stats').innerHTML = `
    <div class="stat"><div class="stat-glow" style="background:var(--green)"></div><div class="stat-icon">üí∞</div><div class="stat-label">‡πÄ‡∏á‡∏¥‡∏ô‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏£‡∏ß‡∏°</div><div class="stat-val g">${fmt(totalBal)}</div><div class="stat-change">‡∏ó‡∏∏‡∏Å‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</div></div>
    <div class="stat"><div class="stat-glow" style="background:var(--green)"></div><div class="stat-icon">üìà</div><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-val g">${fmt(income)}</div></div>
    <div class="stat"><div class="stat-glow" style="background:var(--red)"></div><div class="stat-icon">üìâ</div><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-val r">${fmt(expense)}</div></div>
    <div class="stat"><div class="stat-glow" style="background:var(--sam)"></div><div class="stat-icon">üå¥</div><div class="stat-label">‡∏≠‡∏≠‡∏°‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div><div class="stat-val p">${fmt(saving)}</div></div>`;

  renderDebt('dash-debt');
  renderMiniChart();
  renderRecentTx();
  renderBudgetWidget();
}

function renderDebt(containerId) {
  const shared = cache.transactions.filter(t => t.shared);
  let samNet = 0, porNet = 0;
  shared.forEach(t => {
    if (t.paidBy === 'SAM') porNet += t.amount / 2;
    else if (t.paidBy === 'POR') samNet += t.amount / 2;
  });
  const net = samNet - porNet; // positive = SAM owes POR
  const el = document.getElementById(containerId);
  if (!el) return;
  const arrow = net > 0 ? '‚Üí' : net < 0 ? '‚Üê' : '‚öñÔ∏è';
  const label = net > 0 ? 'SAM ‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ POR' : net < 0 ? 'POR ‡πÇ‡∏≠‡∏ô‡πÉ‡∏´‡πâ SAM' : '‡πÄ‡∏™‡∏°‡∏≠‡∏Å‡∏±‡∏ô!';
  el.innerHTML = `
    <div class="debt-row">
      <div class="debt-person">
        <div class="debt-avi avi-s">S</div>
        <div class="debt-name" style="color:var(--sam)">SAM</div>
      </div>
      <div class="debt-mid">
        <div style="font-size:1.6rem;color:var(--yellow)">${arrow}</div>
        <div class="debt-amt">${fmt(Math.abs(net))}</div>
        <div class="debt-dir">${label}</div>
      </div>
      <div class="debt-person">
        <div class="debt-avi avi-p">P</div>
        <div class="debt-name" style="color:var(--por)">POR</div>
      </div>
    </div>
    <div style="margin-top:14px;padding-top:12px;border-top:1px solid rgba(255,255,255,.06);text-align:center">
      <button class="btn btn-ghost btn-sm" onclick="goPage('split')">‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚Üí</button>
    </div>`;
  const badge = document.getElementById('split-badge');
  if (Math.abs(net) > 0) { badge.style.display = ''; badge.textContent = '!'; }
  else badge.style.display = 'none';
}

function renderMiniChart() {
  const months = [];
  for (let i = 5; i >= 0; i--) {
    const d = new Date(currentMonth.getFullYear(), currentMonth.getMonth() - i, 1);
    const mstr = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    const txs = cache.transactions.filter(t => t.date.startsWith(mstr));
    months.push({ label: MONTHS_SHORT[d.getMonth()], income: sum(txs,'income'), expense: sum(txs,'expense') });
  }
  const maxV = Math.max(...months.flatMap(m => [m.income, m.expense]), 1);
  document.getElementById('dash-chart').innerHTML = `
    <div class="chart-bars">${months.map(m => `
      <div class="chart-bar-grp">
        <div class="chart-b" style="height:${(m.income/maxV)*100}%;background:rgba(61,252,180,.45)" title="‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö ${fmt(m.income)}"></div>
        <div class="chart-b" style="height:${(m.expense/maxV)*100}%;background:rgba(252,92,122,.45)" title="‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢ ${fmt(m.expense)}"></div>
      </div>`).join('')}
    </div>
    <div class="chart-xlabels">${months.map(m=>`<div class="chart-xl">${m.label}</div>`).join('')}</div>`;
}

function renderRecentTx() {
  const recent = getMonthlyTx().slice(0, 7);
  document.getElementById('dash-recent').innerHTML = recent.length
    ? recent.map(t => txRow(t)).join('')
    : '<div class="empty"><div class="emo">üì≠</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</p></div>';
}

function renderBudgetWidget() {
  const tx = getMonthlyTx();
  const m = currentMonthStr();
  const buds = cache.budgets.filter(b => !b.month || b.month === m);
  document.getElementById('dash-budget').innerHTML = buds.length
    ? buds.slice(0,4).map(b => budgetRow(b, tx)).join('')
    : '<div class="empty"><div class="emo">üéØ</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö</p></div>';
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   TRANSACTIONS PAGE                                   ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderTxPage() {
  const q = document.getElementById('search-q')?.value.toLowerCase() || '';
  const fType = document.getElementById('sel-type')?.value || '';
  const fUser = document.getElementById('sel-user')?.value || '';
  const fCat = document.getElementById('sel-cat')?.value || '';
  const mTx = getMonthlyTx();
  let filtered = mTx.filter(t => {
    if (fType && t.type !== fType) return false;
    if (fUser && t.user !== fUser) return false;
    if (fCat && t.category !== fCat) return false;
    if (q && !t.name.toLowerCase().includes(q) && !t.category.toLowerCase().includes(q)) return false;
    return true;
  });
  document.getElementById('tx-summary').innerHTML = `
    <div class="stat" style="padding:13px"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</div><div class="stat-val g" style="font-size:1.15rem">${fmt(sum(filtered,'income'))}</div></div>
    <div class="stat" style="padding:13px"><div class="stat-label">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</div><div class="stat-val r" style="font-size:1.15rem">${fmt(sum(filtered,'expense'))}</div></div>
    <div class="stat" style="padding:13px"><div class="stat-label">‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏™‡∏∏‡∏ó‡∏ò‡∏¥</div><div class="stat-val p" style="font-size:1.15rem">${(() => { const n = sum(filtered,'income')-sum(filtered,'expense'); return (n>=0?'+':'')+fmt(n); })()}</div></div>`;
  document.getElementById('tx-main-list').innerHTML = filtered.length
    ? filtered.map(t => txRow(t)).join('')
    : '<div class="empty"><div class="emo">üì≠</div><p>‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p></div>';
}

function updateCatFilter() {
  const cats = [...new Set(cache.transactions.map(t => t.category))].filter(Boolean);
  document.getElementById('sel-cat').innerHTML = '<option value="">‡∏ó‡∏∏‡∏Å‡∏´‡∏°‡∏ß‡∏î</option>' + cats.map(c => `<option>${c}</option>`).join('');
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   SPLIT PAGE                                          ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderSplit() {
  renderDebt('split-debt');
  const shared = cache.transactions.filter(t => t.shared);
  const samPaid = shared.filter(t => t.paidBy === 'SAM').reduce((a,t)=>a+t.amount,0);
  const porPaid = shared.filter(t => t.paidBy === 'POR').reduce((a,t)=>a+t.amount,0);
  document.getElementById('split-stats').innerHTML = `
    <div style="display:flex;flex-direction:column;gap:10px">
      ${[['‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', shared.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£', ''],
         ['SAM ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', fmt(samPaid), 'color:var(--sam)'],
         ['POR ‡∏à‡πà‡∏≤‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î', fmt(porPaid), 'color:var(--por)'],
         ['‡∏£‡∏ß‡∏°‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢‡∏£‡πà‡∏ß‡∏°', fmt(samPaid+porPaid), '']
        ].map(([l,v,s]) => `<div style="display:flex;justify-content:space-between;align-items:center;font-size:.84rem">
          <span style="color:var(--muted)">${l}</span><span class="fw6 mono" style="${s}">${v}</span></div>`).join('')}
    </div>`;
  const sortedShared = [...shared].sort((a,b) => new Date(b.date)-new Date(a.date));
  document.getElementById('split-list').innerHTML = sortedShared.length
    ? sortedShared.map(t => txRow(t)).join('')
    : '<div class="empty"><div class="emo">‚öñÔ∏è</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏£‡πà‡∏ß‡∏°</p></div>';
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   BUDGET PAGE                                         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderBudget() {
  const tx = getMonthlyTx();
  const m = currentMonthStr();
  const buds = cache.budgets.filter(b => !b.month || b.month === m);
  document.getElementById('budget-main').innerHTML = buds.length
    ? buds.map(b => budgetRow(b, tx, true)).join('')
    : '<div class="empty"><div class="emo">üéØ</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö ‡∏Å‡∏î "+ ‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö" ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°</p></div>';
}

function budgetRow(b, tx, showDel = false) {
  const used = tx.filter(t => t.category === b.category && t.type === 'expense').reduce((a,t)=>a+t.amount,0);
  const pct = b.amount > 0 ? Math.min(100, (used/b.amount)*100) : 0;
  const c = pct > 85 ? 'var(--red)' : pct > 65 ? 'var(--yellow)' : 'var(--green)';
  return `<div class="budget-row">
    <div class="budget-hdr">
      <div class="budget-cat">${ICONS[b.category]||'üìå'} <span>${b.category}</span></div>
      <div style="display:flex;align-items:center;gap:10px">
        <div class="budget-nums"><span style="color:${c};font-weight:700">${fmt(used)}</span> <span class="muted">/ ${fmt(b.amount)}</span></div>
        ${showDel ? `<button class="btn btn-xs btn-danger" onclick="delBudget('${b.id}')">‚úï</button>` : ''}
      </div>
    </div>
    <div class="prog-bar"><div class="prog-fill" style="width:${pct}%;background:${c}"></div></div>
    <div class="prog-labels"><span>${pct.toFixed(0)}% ‡πÉ‡∏ä‡πâ‡πÑ‡∏õ</span><span style="color:${pct>85?'var(--red)':'var(--muted)'}">‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${fmt(Math.max(0,b.amount-used))}</span></div>
  </div>`;
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   SAVINGS PAGE                                        ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderSavings() {
  const total = cache.savings.reduce((a,s)=>a+s.saved,0);
  document.getElementById('total-saved-val').textContent = fmt(total);
  document.getElementById('savings-main').innerHTML = cache.savings.map(s => {
    const pct = s.target > 0 ? Math.min(100,(s.saved/s.target)*100) : 0;
    return `<div class="goal-card">
      <div class="goal-hdr">
        <div>
          <div class="goal-emo">${s.icon}</div>
          <div class="goal-title">${s.name}</div>
          <div class="goal-tgt">‡πÄ‡∏õ‡πâ‡∏≤ ${fmt(s.target)}</div>
        </div>
        <div style="text-align:right">
          <div class="goal-pct">${pct.toFixed(0)}%</div>
          <div style="display:flex;gap:5px;margin-top:6px">
            <button class="btn btn-primary btn-xs" onclick="addToGoal('${s.id}','${s.name}')">+ ‡∏≠‡∏≠‡∏°</button>
            <button class="btn btn-xs btn-danger" onclick="delGoal('${s.id}')">üóëÔ∏è</button>
          </div>
        </div>
      </div>
      <div class="prog-bar" style="height:8px"><div class="prog-fill" style="width:${pct}%;background:linear-gradient(90deg,var(--sam),var(--green))"></div></div>
      <div class="prog-labels"><span style="color:var(--green)">‡∏≠‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß ${fmt(s.saved)}</span><span>‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å ${fmt(Math.max(0,s.target-s.saved))}</span></div>
    </div>`;
  }).join('') || '<div class="empty"><div class="emo">üå¥</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢</p></div>';
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   ACCOUNTS PAGE                                       ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function renderAccounts() {
  const accTypeIco = {'‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î':'üíµ','‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£':'üè¶','Wallet':'üì±'};
  document.getElementById('accounts-main').innerHTML = cache.accounts.map(a => {
    const txs = cache.transactions.filter(t => t.account === a.name);
    const oc = a.owner === 'SAM' ? 'var(--sam)' : a.owner === 'POR' ? 'var(--por)' : 'var(--yellow)';
    return `<div class="acc-card">
      <div class="acc-type-label">${accTypeIco[a.type]||'üí≥'} ${a.type} ¬∑ <span style="color:${oc}">${a.owner}</span></div>
      <div class="acc-name">${a.name}</div>
      <div class="acc-bal" style="color:${a.balance>=0?'var(--green)':'var(--red)'}">${fmt(a.balance)}</div>
      <div class="acc-footer">
        <div class="acc-stat">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö<span style="color:var(--green)">${fmt(sum(txs,'income'))}</span></div>
        <div class="acc-stat" style="text-align:right">‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢<span style="color:var(--red)">${fmt(sum(txs,'expense'))}</span></div>
      </div>
    </div>`;
  }).join('') || '<div class="empty"><div class="emo">üè¶</div><p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ö‡∏±‡∏ç‡∏ä‡∏µ</p></div>';
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   TX ROW TEMPLATE                                     ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function txRow(t) {
  const ico = ICONS[t.category] || 'üìå';
  const col = COLS[t.category] || '#888';
  const uc = t.user === 'SAM' ? 'var(--sam)' : 'var(--por)';
  const amSign = t.type === 'income' ? '+' : '-';
  return `<div class="tx-row" onclick="openEditTx('${t.id}')">
    <div class="tx-ico" style="background:${col}22">${ico}</div>
    <div class="tx-info">
      <div class="tx-name-row">
        <span class="tx-name">${t.name}</span>
        ${t.shared ? '<span class="pill shared">‡∏£‡πà‡∏ß‡∏°</span>' : ''}
        <span class="pill ${t.type}">${t.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : t.type === 'expense' ? '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢' : '‡∏≠‡∏≠‡∏°‡πÄ‡∏á‡∏¥‡∏ô'}</span>
      </div>
      <div class="tx-meta">${t.date} ¬∑ ${t.category} ¬∑ <span style="color:${uc}">${t.user}</span>${t.note ? ' ¬∑ ' + t.note : ''}</div>
    </div>
    <div class="tx-right">
      <div class="tx-amt ${t.type}">${amSign}${fmt(t.amount)}</div>
      ${t.shared ? `<div class="tx-half">${fmt(t.amount/2)}/‡∏Ñ‡∏ô</div>` : ''}
    </div>
    <div class="tx-dot" style="background:${uc}"></div>
  </div>`;
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   ADD / EDIT TX MODAL                                 ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function openAddTx(setShared = false) {
  editingId = null;
  document.getElementById('mo-tx-title').textContent = '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('f-name').value = '';
  document.getElementById('f-amount').value = '';
  document.getElementById('f-date').value = toDateInput(new Date());
  document.getElementById('f-note').value = '';
  document.getElementById('del-tx-btn').style.display = 'none';
  selType('expense');
  populateAccSel();
  sharedOn = setShared;
  syncSharedUI();
  openModal('mo-tx');
}

function openEditTx(id) {
  const t = cache.transactions.find(x => x.id == id);
  if (!t) return;
  editingId = id;
  document.getElementById('mo-tx-title').textContent = '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
  document.getElementById('f-name').value = t.name;
  document.getElementById('f-amount').value = t.amount;
  document.getElementById('f-date').value = t.date;
  document.getElementById('f-note').value = t.note || '';
  document.getElementById('del-tx-btn').style.display = '';
  selType(t.type);
  document.getElementById('f-cat').value = t.category;
  populateAccSel(t.account);
  sharedOn = t.shared;
  if (t.shared) document.getElementById('f-paidby').value = t.paidBy;
  syncSharedUI();
  openModal('mo-tx');
}

function selType(type) {
  selTypeVal = type;
  document.querySelectorAll('.type-opt').forEach(o => {
    o.className = 'type-opt' + (o.dataset.t === type ? ` sel-${type}` : '');
  });
  const cats = CATS[type] || [];
  const sel = document.getElementById('f-cat');
  sel.innerHTML = cats.map(c => `<option>${c}</option>`).join('');
  updateSplitPreview();
}

function populateAccSel(sel = '') {
  const s = document.getElementById('f-account');
  s.innerHTML = cache.accounts.map(a => `<option value="${a.name}" ${a.name===sel?'selected':''}>${a.name}</option>`).join('');
}

function toggleShared() { sharedOn = !sharedOn; syncSharedUI(); }
function syncSharedUI() {
  document.getElementById('tgl-shared').classList.toggle('on', sharedOn);
  document.getElementById('split-ui').style.display = sharedOn ? 'block' : 'none';
  updateSplitPreview();
}
function toggleSP(user) {
  // For simplicity always keep both selected
  toast('‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏≤‡∏£‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 50/50', 'ok');
}
function updateSplitPreview() {
  const amt = parseFloat(document.getElementById('f-amount')?.value) || 0;
  const half = fmt(amt / 2);
  const samEl = document.getElementById('sp-SAM-amt');
  const porEl = document.getElementById('sp-POR-amt');
  if (samEl) samEl.textContent = half;
  if (porEl) porEl.textContent = half;
}

async function saveTx() {
  const name = document.getElementById('f-name').value.trim();
  const amount = parseFloat(document.getElementById('f-amount').value);
  const category = document.getElementById('f-cat').value;
  const date = document.getElementById('f-date').value;
  const account = document.getElementById('f-account').value;
  const note = document.getElementById('f-note').value;
  const paidBy = document.getElementById('f-paidby').value;
  if (!name || !amount || !date) { toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'err'); return; }

  const btn = document.getElementById('save-tx-btn');
  btn.disabled = true; btn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...';

  try {
    if (editingId) {
      await api('updateTransaction', {}, 'POST', { id: editingId, name, amount, type: selTypeVal, category, date, account, note, user: currentUser, shared: sharedOn, paidBy: sharedOn ? paidBy : '' });
      toast('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß ‚úÖ', 'ok');
    } else {
      await api('addTransaction', {}, 'POST', { name, amount, type: selTypeVal, category, date, account, note, user: currentUser, shared: sharedOn, paidBy: sharedOn ? paidBy : '' });
      toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß ‚ú®', 'ok');
    }
    await refreshAll();
    closeModal('mo-tx');
    renderActivePage();
  } catch(e) {
    toast('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + e.message, 'err');
  } finally {
    btn.disabled = false; btn.textContent = 'üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å';
  }
}

async function deleteTx() {
  if (!editingId) return;
  if (!confirm('‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ?')) return;
  try {
    await api('deleteTransaction', {}, 'POST', { id: editingId });
    toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'ok');
    await refreshAll();
    closeModal('mo-tx');
    renderActivePage();
  } catch(e) { toast('‡∏•‡∏ö‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ' + e.message, 'err'); }
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   BUDGET MODAL                                        ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function openBudgetModal() {
  const allCats = CATS.expense;
  document.getElementById('b-cat').innerHTML = allCats.map(c => `<option>${c}</option>`).join('');
  document.getElementById('b-amt').value = '';
  openModal('mo-budget');
}
async function saveBudget() {
  const cat = document.getElementById('b-cat').value;
  const amt = parseFloat(document.getElementById('b-amt').value);
  if (!amt) { toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô', 'err'); return; }
  try {
    await api('setBudget', {}, 'POST', { category: cat, amount: amt, month: currentMonthStr() });
    toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'ok');
    await refreshAll();
    closeModal('mo-budget');
    renderBudget();
  } catch(e) { toast(e.message, 'err'); }
}
async function delBudget(id) {
  if (!confirm('‡∏•‡∏ö‡∏á‡∏ö‡∏ô‡∏µ‡πâ?')) return;
  await api('deleteBudget', {}, 'POST', { id });
  toast('‡∏•‡∏ö‡∏á‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'ok');
  await refreshAll(); renderBudget();
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   SAVING GOAL MODAL                                   ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function openGoalModal() {
  document.getElementById('g-name').value = '';
  document.getElementById('g-icon').value = 'üéØ';
  document.getElementById('g-target').value = '';
  openModal('mo-goal');
}
async function saveGoal() {
  const name = document.getElementById('g-name').value.trim();
  const icon = document.getElementById('g-icon').value.trim() || 'üéØ';
  const target = parseFloat(document.getElementById('g-target').value);
  if (!name || !target) { toast('‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'err'); return; }
  await api('addSavingGoal', {}, 'POST', { name, icon, target });
  toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡πâ‡∏ß!', 'ok');
  await refreshAll(); closeModal('mo-goal'); renderSavings();
}
async function addToGoal(id, name) {
  const amt = parseInt(prompt(`‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÉ‡∏´‡πâ "${name}" ‡πÄ‡∏ó‡πà‡∏≤‡πÑ‡∏´‡∏£‡πà? (‡∏ø)`));
  if (!amt || amt <= 0) return;
  await api('addToSaving', {}, 'POST', { id, amount: amt });
  toast(`‡∏≠‡∏≠‡∏°‡πÄ‡∏û‡∏¥‡πà‡∏° ${fmt(amt)} ‡πÅ‡∏•‡πâ‡∏ß üå¥`, 'ok');
  await refreshAll(); renderSavings();
}
async function delGoal(id) {
  if (!confirm('‡∏•‡∏ö‡πÄ‡∏õ‡πâ‡∏≤‡∏´‡∏°‡∏≤‡∏¢‡∏ô‡∏µ‡πâ?')) return;
  await api('deleteSavingGoal', {}, 'POST', { id });
  toast('‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß', 'ok');
  await refreshAll(); renderSavings();
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   ACCOUNT MODAL                                       ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function openAccModal() {
  document.getElementById('a-name').value = '';
  document.getElementById('a-bal').value = '';
  openModal('mo-acc');
}
async function saveAcc() {
  const name = document.getElementById('a-name').value.trim();
  const type = document.getElementById('a-type').value;
  const balance = parseFloat(document.getElementById('a-bal').value) || 0;
  const owner = document.getElementById('a-owner').value;
  if (!name) { toast('‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', 'err'); return; }
  await api('addAccount', {}, 'POST', { name, type, balance, owner });
  toast('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡πâ‡∏ß', 'ok');
  await refreshAll(); closeModal('mo-acc'); renderAccounts();
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   USER SWITCH                                         ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function switchUser(user) {
  currentUser = user;
  ['SAM','POR'].forEach(u => {
    const btn = document.getElementById('ubtn-' + u);
    btn.classList.toggle('active', u === user);
    btn.querySelector('.active-dot').style.background = u === user ? `var(--${u.toLowerCase()})` : 'transparent';
  });
  toast(`‡∏™‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô ${user} üë§`, 'ok');
}

// ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
// ‚ïë   UTILS                                               ‚ïë
// ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
function fmt(n) { return '‡∏ø' + Math.abs(n||0).toLocaleString('th-TH',{maximumFractionDigits:0}); }
function sum(arr, type) { return arr.filter(t=>t.type===type).reduce((a,t)=>a+t.amount,0); }
function toDateInput(d) { return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0'); }

function openModal(id) { document.getElementById(id).classList.add('open'); }
function closeModal(id) { document.getElementById(id).classList.remove('open'); }
document.querySelectorAll('.overlay').forEach(o => o.addEventListener('click', e => { if(e.target===o) o.classList.remove('open'); }));

function openSidebar() { document.getElementById('sidebar').classList.add('open'); document.getElementById('sb-overlay').classList.add('show'); }
function closeSidebar() { document.getElementById('sidebar').classList.remove('open'); document.getElementById('sb-overlay').classList.remove('show'); }

function setConnStatus(state, text) {
  const dot = document.getElementById('conn-dot');
  dot.className = 'conn-dot ' + state;
  document.getElementById('conn-text').textContent = text;
}

let _toast;
function toast(msg, type = 'ok') {
  const el = document.getElementById('toast');
  el.className = 'toast ' + type;
  el.innerHTML = `${type === 'ok' ? '‚úÖ' : '‚ùå'} ${msg}`;
  el.style.display = 'flex';
  clearTimeout(_toast);
  _toast = setTimeout(() => el.style.display = 'none', 3000);
}
</script>
</body>
</html>
